-- 12/18の東京ログを検索
SELECT
  from_iso8601_timestamp(eventtime)                               AS event_time_utc,
  eventname,
  json_extract_scalar(useridentity, '$.type')                      AS principal_type,
  coalesce(
    json_extract_scalar(useridentity, '$.userName'),
    json_extract_scalar(useridentity, '$.sessionContext.sessionIssuer.userName')
  ) AS who,
  json_extract_scalar(useridentity, '$.arn')                       AS who_arn,
  sourceipaddress,
  useragent
FROM cloudtrail_db.ct_tmp_20241218_tokyo
WHERE eventname = 'RunInstances'
  AND (
    requestparameters  LIKE '%"i-xxxxxxxxxxxxxxxxx"%'
    OR responseelements LIKE '%"i-xxxxxxxxxxxxxxxxx"%'
    OR resources        LIKE '%"i-xxxxxxxxxxxxxxxxx"%'
  )
ORDER BY event_time_utc ASC
LIMIT 100;
