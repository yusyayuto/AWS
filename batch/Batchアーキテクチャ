┌─────────────────────────────────────────────────────────────────┐
│                 JobCompleted とは?                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 定義:                                                            │
│   完了したジョブの総数 (成功 + 失敗)                              │
│                                                                 │
│ 用途:                                                            │
│   1. スループットの測定                                           │
│      → 1分間に何ジョブ完了したか                                  │
│                                                                 │
│   2. リトライ発生率の分母                                         │
│      → リトライ数 / 完了数                                       │
│                                                                 │
│   3. 成功率の分母                                                 │
│      → 成功数 / (成功数 + 失敗数)                                │
│      ※JobCompleted = 成功数 + 失敗数                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────┐
│            JobCompleted 測定の仕組み (AWS Batch)                  │
└─────────────────────────────────────────────────────────────────┘

【SUCCEEDED または FAILED の両方をカウント】

  02:05:00  ┌──────────────────┐
            │ Job 1            │
            │ Status: SUCCEEDED│
            └────────┬─────────┘
                     │
                     ↓ State Change Event
            ┌──────────────────────────────┐
            │ EventBridge                  │
            │ {                            │
            │   "status": "SUCCEEDED"      │
            │ }                            │
            └────────┬─────────────────────┘
                     │
                     ↓ Invoke Lambda
            ┌──────────────────────────────┐
            │ Lambda                       │
            │                              │
            │ if status in ['SUCCEEDED',   │
            │               'FAILED']:     │
            │   put_metric(                │
            │     'JobCompleted', 1        │
            │   )                          │
            └──────────────────────────────┘
                     │
                     ↓
            ┌──────────────────────────────┐
            │ CloudWatch Metrics           │
            │ JobCompleted: +1             │
            └──────────────────────────────┘
  
  
  02:10:00  ┌──────────────────┐
            │ Job 2            │
            │ Status: FAILED   │
            └────────┬─────────┘
                     │
                     ↓ State Change Event
            ┌──────────────────────────────┐
            │ EventBridge                  │
            │ {                            │
            │   "status": "FAILED"         │
            │ }                            │
            └────────┬─────────────────────┘
                     │
                     ↓ Invoke Lambda
            ┌──────────────────────────────┐
            │ Lambda                       │
            │                              │
            │ if status in ['SUCCEEDED',   │
            │               'FAILED']:     │
            │   put_metric(                │
            │     'JobCompleted', 1        │
            │   )                          │
            └──────────────────────────────┘
                     │
                     ↓
            ┌──────────────────────────────┐
            │ CloudWatch Metrics           │
            │ JobCompleted: +1             │ ← 失敗もカウント
            └──────────────────────────────┘


【時系列でのカウント】

  時間軸
    ↓
  02:00  ジョブ1 SUCCEEDED → JobCompleted: 1
    │
  02:05  ジョブ2 SUCCEEDED → JobCompleted: 1
    │
  02:10  ジョブ3 FAILED    → JobCompleted: 1
    │
  02:15  ジョブ4 SUCCEEDED → JobCompleted: 1
    │
  02:20  ジョブ5 SUCCEEDED → JobCompleted: 1
    │
    ↓
  
  集計 (Sum, 5分間):
    02:00-02:05  JobCompleted: 2
    02:05-02:10  JobCompleted: 1
    02:10-02:15  JobCompleted: 1
    02:15-02:20  JobCompleted: 1


【Dashboard での可視化】

  スループット (完了ジョブ数/分):
  
  ┌────────────────────────────────────────┐
  │ スループット (critical)                 │
  ├────────────────────────────────────────┤
  │                                        │ 150
  │             ╱────╲                     │
  │           ╱        ╲                   │
  │         ╱            ╲                 │ 100 ← SLO目標
  │       ╱                ╲               │
  │     ╱                    ╲             │
  ├────────────────────────────────────────┤ 50
  │ 02:00  03:00  04:00  05:00  06:00     │
  └────────────────────────────────────────┘
  
  メトリクス設定:
    - JobCompleted-batch-critical
    - Statistic: Sum
    - Period: 1分
    - 単位: Count
