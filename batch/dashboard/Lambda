{
  "widgets": [
    {
      "type": "metric",
      "x": 0,
      "y": 0,
      "width": 24,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m1+m2,0)==0,100,100*FILL(m1,0)/FILL(m1+m2,0))",
              "label": "バッチ成功率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "AWS/States",
            "ExecutionsSucceeded",
            "StateMachineArn",
            "arn:aws:states:ap-northeast-1:123456789012:stateMachine:lambda-etl-with-wait-time",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            ".",
            "ExecutionsFailed",
            ".",
            ".",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 95,
            "max": 100,
            "label": "成功率(%)",
            "showUnits": false
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO目標(≧99.5%)",
              "value": 99.5,
              "fill": "below"
            }
          ]
        },
        "title": "バッチ全体成功率 (Step Functions基準)"
      }
    },

    /* ───────── 1行目: 各ジョブの成功率 ───────── */

    {
      "type": "metric",
      "x": 0,
      "y": 6,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m1+m2,0)==0,100,100*FILL(m1,0)/FILL(m1+m2,0))",
              "label": "成功率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobSucceeded",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobFailed",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 95,
            "max": 100,
            "label": "成功率(%)",
            "showUnits": false
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO目標(≧99.5%)",
              "value": 99.5,
              "fill": "below"
            }
          ]
        },
        "title": "注文集計(order_summary) ジョブ成功率"
      }
    },

    {
      "type": "metric",
      "x": 8,
      "y": 6,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m1+m2,0)==0,100,100*FILL(m1,0)/FILL(m1+m2,0))",
              "label": "成功率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobSucceeded",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobFailed",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 95,
            "max": 100,
            "label": "成功率(%)",
            "showUnits": false
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO目標(≧99.5%)",
              "value": 99.5,
              "fill": "below"
            }
          ]
        },
        "title": "在庫更新(inventory_update) ジョブ成功率"
      }
    },

    {
      "type": "metric",
      "x": 16,
      "y": 6,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m1+m2,0)==0,100,100*FILL(m1,0)/FILL(m1+m2,0))",
              "label": "成功率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobSucceeded",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobFailed",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 95,
            "max": 100,
            "label": "成功率(%)",
            "showUnits": false
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO目標(≧99.5%)",
              "value": 99.5,
              "fill": "below"
            }
          ]
        },
        "title": "レポート生成(report_generation) ジョブ成功率"
      }
    },

    /* ───────── 2行目: 各ジョブの処理時間 P95 ───────── */

    {
      "type": "metric",
      "x": 0,
      "y": 12,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            "ETL/Batch",
            "JobDurationSeconds",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda"
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "p95",
        "period": 60,
        "yAxis": {
          "left": {
            "label": "処理時間(秒)",
            "min": 0,
            "max": 600
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦600秒=10分)",
              "value": 600,
              "fill": "above"
            }
          ]
        },
        "title": "注文集計(order_summary) 処理時間 P95"
      }
    },

    {
      "type": "metric",
      "x": 8,
      "y": 12,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            "ETL/Batch",
            "JobDurationSeconds",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda"
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "p95",
        "period": 60,
        "yAxis": {
          "left": {
            "label": "処理時間(秒)",
            "min": 0,
            "max": 600
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦600秒=10分)",
              "value": 600,
              "fill": "above"
            }
          ]
        },
        "title": "在庫更新(inventory_update) 処理時間 P95"
      }
    },

    {
      "type": "metric",
      "x": 16,
      "y": 12,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            "ETL/Batch",
            "JobDurationSeconds",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda"
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "p95",
        "period": 60,
        "yAxis": {
          "left": {
            "label": "処理時間(秒)",
            "min": 0,
            "max": 600
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦600秒=10分)",
              "value": 600,
              "fill": "above"
            }
          ]
        },
        "title": "レポート生成(report_generation) 処理時間 P95"
      }
    },

    /* ───────── 3行目: 各ジョブの待機時間 P95 ───────── */

    {
      "type": "metric",
      "x": 0,
      "y": 18,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            "ETL/Batch",
            "JobWaitTimeSeconds",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda"
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "p95",
        "period": 60,
        "yAxis": {
          "left": {
            "label": "待機時間(秒)",
            "min": 0,
            "max": 120
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦60秒)",
              "value": 60,
              "fill": "above"
            }
          ]
        },
        "title": "注文集計(order_summary) 待機時間 P95"
      }
    },

    {
      "type": "metric",
      "x": 8,
      "y": 18,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            "ETL/Batch",
            "JobWaitTimeSeconds",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda"
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "p95",
        "period": 60,
        "yAxis": {
          "left": {
            "label": "待機時間(秒)",
            "min": 0,
            "max": 120
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦60秒)",
              "value": 60,
              "fill": "above"
            }
          ]
        },
        "title": "在庫更新(inventory_update) 待機時間 P95"
      }
    },

    {
      "type": "metric",
      "x": 16,
      "y": 18,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            "ETL/Batch",
            "JobWaitTimeSeconds",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda"
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "p95",
        "period": 60,
        "yAxis": {
          "left": {
            "label": "待機時間(秒)",
            "min": 0,
            "max": 120
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦60秒)",
              "value": 60,
              "fill": "above"
            }
          ]
        },
        "title": "レポート生成(report_generation) 待機時間 P95"
      }
    },

    /* ───────── 4行目: 各ジョブのリトライ発生率 ───────── */

    {
      "type": "metric",
      "x": 0,
      "y": 24,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m2+m3,0)==0,0,100*FILL(m1,0)/FILL(m2+m3,0))",
              "label": "Retry発生率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobRetryCount",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobSucceeded",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobFailed",
            "JobType",
            "order_summary",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m3",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 0,
            "max": 5,
            "label": "Retry発生率(%)"
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦1%)",
              "value": 1,
              "fill": "above"
            }
          ]
        },
        "title": "注文集計(order_summary) Retry発生率"
      }
    },

    {
      "type": "metric",
      "x": 8,
      "y": 24,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m2+m3,0)==0,0,100*FILL(m1,0)/FILL(m2+m3,0))",
              "label": "Retry発生率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobRetryCount",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobSucceeded",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobFailed",
            "JobType",
            "inventory_update",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m3",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 0,
            "max": 5,
            "label": "Retry発生率(%)"
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦1%)",
              "value": 1,
              "fill": "above"
            }
          ]
        },
        "title": "在庫更新(inventory_update) Retry発生率"
      }
    },

    {
      "type": "metric",
      "x": 16,
      "y": 24,
      "width": 8,
      "height": 6,
      "properties": {
        "metrics": [
          [
            {
              "expression": "IF(FILL(m2+m3,0)==0,0,100*FILL(m1,0)/FILL(m2+m3,0))",
              "label": "Retry発生率(%)",
              "id": "e1",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobRetryCount",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m1",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobSucceeded",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m2",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ],
          [
            "ETL/Batch",
            "JobFailed",
            "JobType",
            "report_generation",
            "ExecutionEnv",
            "lambda",
            {
              "id": "m3",
              "stat": "Sum",
              "region": "ap-northeast-1",
              "period": 60
            }
          ]
        ],
        "view": "timeSeries",
        "stacked": false,
        "region": "ap-northeast-1",
        "stat": "Sum",
        "period": 60,
        "yAxis": {
          "left": {
            "min": 0,
            "max": 5,
            "label": "Retry発生率(%)"
          }
        },
        "annotations": {
          "horizontal": [
            {
              "label": "SLO(≦1%)",
              "value": 1,
              "fill": "above"
            }
          ]
        },
        "title": "レポート生成(report_generation) Retry発生率"
      }
    }
  ]
}
